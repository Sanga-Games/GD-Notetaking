<!DOCTYPE html>
<html>
  <head>
    <title>Sanga Games  - Docs</title>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
    <meta name="referrer" content="no-referrer-when-downgrade">
    <style>
@font-face {
  font-family: 'Sans-Serif Workhorse';
  src: url('path/to/sans-serif-workhorse-font.woff2') format('woff2'),
       url('path/to/sans-serif-workhorse-font.woff') format('woff');
}
#FileListContent .jstree-wholerow-clicked {
  background: #dcdcdc !important; /* Change this value to the desired color */
}

#FileListContent .jstree-wholerow-hovered {
  background-color: #ededed !important;
}

#FileListContent .jstree-clicked {
  color: #444 !important;
}
#FileListContent .jstree-anchor {
  font-weight: 700;
  font-size:12px;
  font-family: 'Sans-Serif Workhorse', sans-serif;
  color:#777;
}



.jstree-contextmenu {
  background-color: #f5f5f5; /* Set the background color */
  border: 1px solid #ddd;
  font-family: Arial, sans-serif; /* Set the font family */
  font-size: 10px; /* Set the font size */
  width: 150px; /* Set the width of the context menu */
}

.jstree-contextmenu .vakata-context {
  color: #494949; /* Set the font color */
  padding: 5px 10px;
  height: 20px; /* Set the height of each menu item */
  line-height: 20px; /* Set the line height to center the text vertically */
}

.jstree-contextmenu .vakata-context-hover {
  background-color: #e0e0e0; /* Set the background color when hovered */
}

.jstree-contextmenu .vakata-context-disabled {
  opacity: 0.5; /* Set the opacity for disabled items */
}

.jstree-contextmenu .vakata-context-separator {
  border-top: 1px solid #ddd; /* Set the separator line color */
}

.jstree-contextmenu .vakata-context .vakata-contexticon {
  display: none; /* Hide the icon space */
}

.jstree-contextmenu .vakata-contextmenu-sep {
  display: none !important; /* Hide the icon space */
}

      html, body 
      {
        min-height: 100% !important;
        height:100%;
        margin:0px;
        border:0px;
      }
      #rootcontainer,#AuthScreen
      {
        position: absolute;
        height:100%;
        width:100%;
      }
      #signin_button
      {
        position: absolute;
        top: 50%;
        left: 50%;
        -ms-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
      }
      #signout_button
      {
        position:absolute;
        font-weight:bold; 
        color:#333; 
        font-size: 14px;
        right:0px; 
        top:0px; 
        background:white;  
        height:28px; 
        margin:1px; 
        margin-right:10px;margin-top:6px;
        border:1px solid #ddd;
        border-radius: 5px;
        padding-left:10px;
        padding-right:10px;
      }
      #signout_button:hover
      {
        background-color:#ff2f5c;
        color:white;
        cursor: pointer;
        transition: 0.3s;
      } 
      #signout_button:hover:after
      {
        content:" - SIGN OUT";
      }
      #sidebar
      {
        position: relative;  
        resize: horizontal;
        overflow: auto;
        min-width:100px;
        width:250px;
        max-width:600px;
        float:left;
        height:100%;
        background:#fafafa;
        box-sizing: border-box;
        border-right:  1px solid #efefef;
      }
      #contentholder
      {  
        position: relative;
        overflow: auto;
        height:100%;
        background:white;
      }
      #WorkspaceSelector
      {
        position:relative;
        background-color:white;
        border: 1px solid #ccc;
        float:left;
        margin-left:10px;
        height:24px;
        width:100%;
        margin-right:10px;
        flex-grow: 1;
        border-radius: 5px;
        font-weight:700;
        color:#555;
        font-family: 'Sans-Serif Workhorse', sans-serif;
      }
      #FileListContainer
      {
        display:flex;
        flex-direction: row;
        width:100%;
        height:100%;
      }
      #FileListContent
      {
        font-size:11px;
      }
      #FileEmbed
      {
        position:absolute;
        width:100%;
        height:100%;
        border:none;
        box-sizing: border-box;
      }
      #QuickButtonsContainer
      {
        position: absolute;
        display: flex;
        left:0px;
        top:35px;
        width:100%;
        height:35px;
        border-bottom: 1px solid #efefef;
      }
      .QuickButtons
      {
        position:relative;
        flex-grow: 1;
        margin:4px;
        border-radius: 5px;
        border: 1px solid #efefef;
        background-color: white;
        color:#777;
        font-weight:700;
        cursor:pointer;
      }
      .QuickButtons:hover
      {
        background-color: rgb(212, 227, 255);
        border: 1px solid #999;
      }
    </style>
  </head>
  <body>

    <div id="AuthScreen">
      <!-- <button id="signin_button"  style="display: block;" onclick="HandleAuth();" >SIGN IN</button> -->
      <div id="g_id_onload" style="display:none"
          data-client_id="922877380869-464psb1ou671ss81ktsjfjo2to7hgtsi.apps.googleusercontent.com"
          data-context="use"
          data-ux_mode="popup"
          data-callback="HandleAuth"
          data-auto_prompt="false">
      </div>

      <div class="g_id_signin" id="signin_button" style="display:none"
          data-type="standard"
          data-shape="rectangular"
          data-theme="filled_blue"
          data-text="signin_with"
          data-size="large"
          data-logo_alignment="left"
          data-width="200">
      </div>
    </div>
    <div id="rootcontainer" style="display:none;">
      <div id="sidebar">
        <div style="position:absolute; height:30px; border-bottom: 1px solid #efefef; top:6px; left:0px; width:100%; box-sizing: border-box;"> 
          <button id="addWorkspaceButton" onclick="createPicker()" style="position:relative;float:right;margin-right:10px;border-radius: 5px; background-color: #2f78ff; color:white; font-weight: 900; border: none; font-size: 17px; width:30px; height:24px;padding:0px; cursor:pointer;">+</button>
          <div style="display:flex; align-items: center;">
            <select id="WorkspaceSelector" onchange="handleWorkspaceChange()">
              <option value="" disabled selected>Select your Workspace</option>
            </select>
          </div>
        </div>
        <div id="QuickButtonsContainer" >
            <button class="QuickButtons" title="Search" style="margin-left:10px;">üîç</button>
            <button class="QuickButtons"  title="Activity">üì∞</button>
            <button class="QuickButtons"  title="Open in new Tab" onclick="OpenDocInNewTab()" style="margin-right:10px;">üîó</button>
        </div>
        <div id="FileListContainer">
          <div style="flex-grow:1; margin-top:75px;margin-bottom:50px; position:relative;">
            <div id="FileListContent" style="position:absolute; width:100%; height:100%; left:0px; top:0px;">
                <!-- Side bar content goes in here -->
            </div>
          </div>
        </div>
        <div style="position:absolute; height:36px; border-top: 1px solid #efefef; bottom:6px; left:0px; width:100%; box-sizing: border-box;">  
          <img id="ProfilePicture" referrerpolicy="no-referrer" alt="Pic" Title="Profile Picture" style="position: relative;border-radius: 5px;  float:left; width:26px; height:26px; margin:1px; margin-left:10px;border: 1px solid #ddd;margin-top:6px;"/>
          <div id="EmailDisplay" style="overflow:hidden; font-family: 'Sans-Serif Workhorse', sans-serif; font-size:18px; color:#666; text-align: left; padding-left: 6px; padding-top: 10px; font-weight:700;"></div>
          <button id="signout_button" onclick="handleSignoutClick()" title="Ideograph to leave; to depart; to separate, distant from, a village in ancient times in Anyi CJK">‰ßÅ</button>
        </div>
      </div>
      <div id="contentholder">
        <iframe id="FileEmbed" ng-non-bindable="" frameborder="0" hspace="0" marginheight="0" marginwidth="0" scrolling="no"  ></iframe>
      </div>
    </div>


    <script type="text/javascript">

      const CLIENT_ID = '922877380869-464psb1ou671ss81ktsjfjo2to7hgtsi.apps.googleusercontent.com';
      const API_KEY = 'AIzaSyCd0pkvt1TxnXVz4uZa83Mp8zMfl77_3hU';
      // Discovery doc URL for APIs used by the quickstart
      const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      const SCOPES = 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.file';



      let tokenClient;
      let email="";
      let gapiInited = false;
      let gisInited = false;
      let FilesListJSON = [];
      let WorkspacesJSON = {};
      /**
       * Callback after api.js is loaded.
       */
      function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
      }

      /**
       * Callback after the API client is loaded. Loads the
       * discovery doc to initialize the API.
       */
      async function initializeGapiClient() {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: [DISCOVERY_DOC],
        });
        gapi.client.load('drive', 'v3');
        gapiInited = true;
        console.log("gapi Initiated")
        loadPicker();
        maybeEnableButtons();
      }

      /**
       * Callback after Google Identity Services are loaded.
       */
      async function gisLoaded() {
        tokenClient = google.accounts.oauth2.initCodeClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          ux_mode: 'redirect',
          redirect_uri: "https://2cxelspxlziyca4d34g6nmqyxa0xdptg.lambda-url.ap-south-1.on.aws",
          state: "YOUR_BINDING_VALUE"
          // ux_mode: 'popup',
          // callback: (response) => {
          //   UpdateAcessToken(response.code);
          //   const xhr = new XMLHttpRequest();
          //   xhr.open('POST', 'https://2cxelspxlziyca4d34g6nmqyxa0xdptg.lambda-url.ap-south-1.on.aws' , true);
          //   xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
          //   // Set custom header for CRSF
          //   xhr.setRequestHeader('X-Requested-With', 'XmlHttpRequest');
          //   xhr.onload = function() {
          //     console.log('Auth code response: ' + xhr.responseText);
          //     HandleAuth();
          //   };
          //   xhr.send('code=' + response.code);
          // },
        });
        gisInited = true;
        console.log("gis Initiated");
        maybeEnableButtons();
      }

      async function HandleAuth(response=null)
      {
        console.log("Trying to handle auth");
        if(response)
        {
          let tmp = getEmailFromIdToken(response.credential);
          if(isValidEmail(tmp))
          {
            email = tmp;
            setCookie("email",email,360);
            console.log(email);
          }
          else
          {
            email = "";
          }  
        }

        let tmpAccessToken = await TryToGetAccessToken();
        console.log(tmpAccessToken);
        if(tmpAccessToken && tmpAccessToken!="" && tmpAccessToken != "null")
        {
          console.log("Access Token received");
          UpdateAcessToken(tmpAccessToken);
        }
        else
        {
          console.log("Requesting auth code");
          tokenClient.requestCode();
        }
      }

      function UpdateAcessToken(AccessToken)
      {
        gapi.client.setToken({ access_token: AccessToken });
        if(document.getElementById('rootcontainer').style.display =='none')
        {
          document.getElementById('rootcontainer').style.display = 'block';
          document.getElementById('AuthScreen').style.display = 'none';
          fetchUserInfo();
          fetchConfigJson();
        }
        else
        {
          console.log("Only Access Token refereshed");
        }
        scheduleTokenRenewal();
      }

      async function TryToGetAccessToken() {
        if(email == "")
          return "";
        const url = 'https://2cxelspxlziyca4d34g6nmqyxa0xdptg.lambda-url.ap-south-1.on.aws/access?email=' + email;

        try {
          const response = await fetch(url);
          const data = await response.text();
          console.log(response);
          return data;
        } catch (error) {
          console.error('Error:', error);
          return "";
        }
      }


      function getEmailFromIdToken(idToken) {
        try {
          const tokenPayload = idToken.split('.')[1];
          const decodedPayload = atob(tokenPayload);
          const payloadObj = JSON.parse(decodedPayload);
          const email = payloadObj.email;
          return email;
        } catch (error) {
          console.error('Error decoding ID token:', error);
          return null;
        }
      }

      function isValidEmail(email) {
        // Regular expression pattern for email validation
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        // Test the email against the pattern
        return emailPattern.test(email);
      }


      // Schedule the token renewal before it expires
      function scheduleTokenRenewal() {
        setTimeout(renewAccessToken, 50 * 60 * 1000);
      }

      // Renew the access token
      async function renewAccessToken() {
        console.log("trying to renew access token");
        UpdateAcessToken(await TryToGetAccessToken());
      }


      /**
       * Enables user interaction after all libraries are loaded.
       */
      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
          email = getCookie("email");
          if(email && email != "")
          {
            HandleAuth();
          }
          else
          {
            document.getElementById('signin_button').style.display = 'block';
            document.getElementById('g_id_onload').style.display = 'block';
          }
        }
      }

      /**
       *  Sign out the user upon button click.
       */
      function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          //google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken('');
          document.getElementById('rootcontainer').style.display = 'none';
          document.getElementById('AuthScreen').style.display = 'block';
          document.getElementById('signin_button').style.display = 'block';
            document.getElementById('g_id_onload').style.display = 'block';
          // Delete the access token cookie
          setCookie("email", "", -1);
        }
      }

      async function fetchUserInfo() {
      try {
        const response = await gapi.client.request({
          path: 'https://people.googleapis.com/v1/people/me?personFields=emailAddresses,names,photos',
        });

        const email = response.result.emailAddresses[0].value;
        const pictureUrl = response.result.photos[0].url;

        document.getElementById("ProfilePicture").src = pictureUrl;

        const EmailArray = email.split("@");
        document.getElementById("EmailDisplay").innerText = EmailArray[0].toUpperCase();

        // Use the email and picture URL as needed (e.g., display in the UI)
        setCookie("email",email,360);
        console.log('Email:', email);
        console.log('Picture URL:', pictureUrl);
      } catch (error) {
        console.error('Error fetching user info:', error);
      }
    }


    // Define the function to handle folder selection
    function handleFolderSelection(data) {
      console.log('picker callback called');
      if (data.action === google.picker.Action.PICKED) {
        var folder = data.docs[0];
        console.log('Selected folder:', folder);
        
        // Perform actions with the selected folder
        WorkspacesJSON["ActiveWorkspaceID"] = folder["id"];
        WorkspacesJSON["ActiveWorkspaceName"] = folder["name"];
        // Initialize "Workspaces" property if it doesn't exist
        if (!WorkspacesJSON["Workspaces"]) {
          WorkspacesJSON["Workspaces"] = [];
        }
        // Push new workspace object into "Workspaces" array
        WorkspacesJSON["Workspaces"].push({
          id: folder["id"],
          name: folder["name"],
        });
        fillWorkspacesList();
        saveConfigJson();
      }
    }

    // Load the Google Picker API
    function loadPicker() {
      gapi.load('picker');
    }

    // Create and render the folder picker
    function createPicker() {
      var docsView = new google.picker.DocsView()
          .setIncludeFolders(true) 
          .setMimeTypes('application/vnd.google-apps.folder')
          .setSelectFolderEnabled(true);

      var picker = new google.picker.PickerBuilder()
        .addView(docsView)
        .setOAuthToken(gapi.auth.getToken().access_token)
        .setCallback(handleFolderSelection)
        .build();

      picker.setVisible(true);
    }

    async function old_getFileHierarchy(directoryId) {
      let response;
      try {
        response = await gapi.client.drive.files.list({
          'q': `'${directoryId}' in parents and trashed = false`,
          'pageSize': 100,
          'fields': 'files(id, name, mimeType)',
        });
      } catch (err) {
        document.getElementById('FileListContent').innerText = err.message;
        return [];
      }

      console.log(response);
      const files = response.result.files;
      if (!files || files.length === 0) {
        document.getElementById('FileListContent').innerText = 'No files found.';
        return [];
      }

      const FilesListJSON = [];
      for (const file of files) {
        const fileInfo = {
          id: file.id,
          name: file.name,
          mimeType: file.mimeType,
          level: level,
        };
        if (file.mimeType === 'application/vnd.google-apps.folder') {
          fileInfo.children = await getFileHierarchy(file.id, level + 1);
        }
        FilesListJSON.push(fileInfo);
      }

      return FilesListJSON;
    }


    function timeuuid() {
      var dt = new Date().getTime();
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,
      function( c ) {
          var rnd = Math.random() * 16;//random number in range 0 to 16
          rnd = (dt + rnd)%16 | 0;
          dt = Math.floor(dt/16);
          return (c === 'x' ? rnd : (rnd & 0x3 | 0x8)).toString(16);
      });
    }

    async function GetAllFilesInFlatHierarchy(directoryId) {
      let jsonData = [];

      const stack = [directoryId]; // Stack to keep track of directories to process

      while (stack.length > 0) {
        const currentDirectoryId = stack.pop();

        try {
          const response = await gapi.client.drive.files.list({
            'q': `'${currentDirectoryId}' in parents and trashed = false`,
            'pageSize': 100,
            'fields': 'files(id, name, mimeType)',
          });

          const filesInDirectory = response.result.files;
          if (filesInDirectory && filesInDirectory.length > 0) {
            for (const file of filesInDirectory) {
              if (file.mimeType !== 'application/vnd.google-apps.folder') {
                jsonData.push({
                  id: file.id,
                  text: file.name,
                  level: 1,
                  data:{
                    locked:false,
                    mimeType: file.mimeType,
                  }
                });
              } else {
                stack.push(file.id); // Add subfolder to the stack for processing
              }
            }
          }
        } catch (err) {
          document.getElementById('FileListContent').innerText = err.message;
          return [];
        }
      }
      console.log(jsonData);
      return jsonData;
    }



    async function getFileHierarchy(directoryId) 
    {
      // Check if FileHierarchy.json exists
      let response;
      let fileHierarchyJson = null;
      try {
        response = await gapi.client.drive.files.list({
          'q': `'${directoryId}' in parents and trashed = false and name = 'FileHierarchy.json'`,
          'pageSize': 1,
          'fields': 'files(id, name, mimeType)',
        });
      } catch (err) {
        document.getElementById('FileListContent').innerText = err.message;
        return [];
      }

      const files = response.result.files;
      if (files && files.length > 0) {
        // FileHierarchy.json exists, retrieve its content
        console.log("FileHierarchy.json exists")
        const fileId = files[0].id;
        try {
          response = await gapi.client.drive.files.get({
            'fileId': fileId,
            'alt': 'media'
          });
          fileHierarchyJson = JSON.parse(response.body);
        } catch (err) {
          document.getElementById('FileListContent').innerText = err.message;
          return [];
        }
      }

      if (!fileHierarchyJson) {
        // FileHierarchy.json does not exist, create new hierarchy
        fileHierarchyJson = [{
            id: timeuuid(),
            text: 'Content',
            level:0,
            children: [],
            data:{
              locked:true,
              mimeType: 'application/folder',
            }
          },
          {
            id: timeuuid(),
            text: 'Archived',
            level:0,
            children: [],
            data:{
              locked:true,
              mimeType: 'application/folder',
            }
          }
        ];

        // Retrieve files in the current directory
        let jsonData = await GetAllFilesInFlatHierarchy(directoryId);
        fileHierarchyJson[0].children = jsonData;

      }

      const token = gapi.auth.getToken().access_token;
      const headers = new Headers({ 'Authorization': 'Bearer ' + token });

      // Save the updated hierarchy to FileHierarchy.json
      if (fileHierarchyJson) {
        try {
          if (files && files.length > 0) {
            console.log("updating file");
            const fileId = files[0].id;
            fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
              method: 'PATCH',
              headers: headers,
              body: JSON.stringify(fileHierarchyJson)
            })
              .then(res => res.json())
              .then(res => console.log(res))
              .catch(err => console.error(err));

          } else {
            console.log("creating file");
            const fileMetadata = {
              name: 'FileHierarchy.json',
              parents: [directoryId]
            };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
            form.append('file', new Blob([JSON.stringify(fileHierarchyJson)], { type: 'application/json' }));

             // File does not exist, create using POST
             fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
              method: 'POST',
              headers: headers,
              body: form
            })
              .then(res => res.json())
              .then(res => console.log(res))
              .catch(err => console.error(err));
          }
        } catch (err) {
          document.getElementById('FileListContent').innerText = err.message;
          return [];
        }
      }

      return fileHierarchyJson;
    }


    function initializeFileTree(fileData) {

      // Destroy the existing jstree instance if it exists
      if ($('#FileListContent').jstree()) {
        $('#FileListContent').jstree('destroy');
      }

      $('#FileListContent').jstree({
        core: {
          data: fileData,
          check_callback: true,
          themes: {
            icons: false,
            dots:false
          },
          selection: {
            type: 'full'
          },
        },
        dnd: {
          large_drag_target: true,
          large_drop_target: true,
          is_draggable: function(node) {
            // Allow dragging only if the node is not locked
            return node[0].data.locked===false;
          }
        },
        contextmenu: {
          items: function(node) {
            const menuItems = {
              addFolder: {
                label: 'Add Folder',
                action: function(data) {
                  // Handle the Add Folder action
                  console.log('Add Folder clicked');
                  CreateNewFolder(data,"New Folder");
                }
              },
              addDocument: {
                label: 'Add Document',
                action: function(data) {
                  // Handle the Add Document action
                  console.log('Add Document clicked');
                  CreateNewFile(data,'application/vnd.google-apps.document',"New Document");
                }
              },
              addSheet: {
                label: 'Add Sheet',
                action: function(data) {
                  // Handle the Add Sheet action
                  console.log('Add Sheet clicked');
                  CreateNewFile(data,'application/vnd.google-apps.spreadsheet',"New Sheet");
                }
              },
              addPresentation: {
                label: 'Add Presentation',
                action: function(data) {
                  // Handle the Add Presentation action
                  console.log('Add Presentation clicked');
                  CreateNewFile(data,'application/vnd.google-apps.presentation',"New Presentation");
                }
              },
              addLink: {
                label: 'Add Link',
                action: function(data) {
                  // Handle the Add Presentation action
                  console.log('Add Link clicked');
                  let linkurl = prompt("Paste Url you want to Link");
                  let linkText = prompt("Type in Alias Name for the Link");
                  CreateNewLink(data,linkText,linkurl);
                }
              },
              rename: {
                label: 'Rename',
                action: function(data) {
                  // Trigger rename mode on the selected node
                  const instance = $.jstree.reference(data.reference);
                  var node = instance.get_node(data.reference);
                  instance.edit(node);
                },
                _disabled: function(data) {
                  // Disable the "Move to Archived" menu item if the node is locked
                  var inst = $.jstree.reference(data.reference)
                  var node = inst.get_node(data.reference);
                  return node.data.locked===true;
                }
              },
              deleteFile: {
                label: 'Delete',
                action: function(data) {
                  // Handle the Add Presentation action
                  console.log('Add Link clicked');
                  deleteFile(data);
                },
                _disabled: function(data) {
                  // Disable the "Move to Archived" menu item if the node is locked
                  var inst = $.jstree.reference(data.reference)
                  var node = inst.get_node(data.reference);
                  return node.data.locked===true;
                }
              }
            };

            // Customize the context menu items based on the node type or any other conditions
            // For example, you can disable certain items based on node properties

            return menuItems;
          }
        },
        plugins: ['dnd', 'state','wholerow', 'contextmenu', 'rename']
      });

      $('#FileListContent').on('select_node.jstree', function (e, data) {
        const selectedNodeId = data.node.id;
        const selectedNode = data.instance.get_node(selectedNodeId);

        if (selectedNode && selectedNode.data) {
          if(selectedNode.data.url)
          {
            embedFile(selectedNode.id, selectedNode.data.mimeType,selectedNode.data.url);
          }
          else
          {
            embedFile(selectedNode.id, selectedNode.data.mimeType);
          }
        }
      });

      $('#FileListContent').on('move_node.jstree', function (e, data) {
        
          SaveFileHierarchyToWorkspace();
      });

      $('#FileListContent').on('create_node.jstree', function (e, data) {
        
        // Log the JSON hierarchy object
        console.log("jstree updated");
          SaveFileHierarchyToWorkspace();
      });


      $('#FileListContent').on('delete_node.jstree', function (e, data) {
        
        // Log the JSON hierarchy object
        console.log("jstree updated");
          SaveFileHierarchyToWorkspace();
      });

      $('#FileListContent').on('rename_node.jstree', function(e, data) {
          const renamedNodeId = data.node.id;
          const renamedNodeText = data.text;
          console.log(`Node ${renamedNodeId} renamed to ${renamedNodeText}`);

          if(data.node.data.mimeType.includes("application/vnd.google-apps"))
          // Handle the rename event here
          updateGoogleDriveFileName(renamedNodeId, renamedNodeText);
          SaveFileHierarchyToWorkspace();
      });

      
    }


    async function UpdateFileHierarchyToWorkspace(directoryId) {
      const hierarchy = await getFileHierarchy(directoryId);
      initializeFileTree(hierarchy);
    }

    async function SaveFileHierarchyToWorkspace()
    {
      console.log("Trying to save file hierarchy");
      accessToken = gapi.auth.getToken().access_token;
      headers = {
            Authorization: `Bearer ${accessToken}`,
            'Content-Type': 'application/json',
          };

      let response;
      let fileHierarchyJson = null;
      try {
        response = await gapi.client.drive.files.list({
          'q': `'${WorkspacesJSON["ActiveWorkspaceID"]}' in parents and trashed = false and name = 'FileHierarchy.json'`,
          'pageSize': 1,
          'fields': 'files(id, name, mimeType)',
        });
      } catch (err) {
        document.getElementById('FileListContent').innerText = err.message;
        return [];
      }
      const files = response.result.files;
      if (files && files.length > 0) {
        const fileId = files[0].id;
        fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
          method: 'PATCH',
          headers: headers,
          body: JSON.stringify($('#FileListContent').jstree(true).get_json())
        })
          .then(res => res.json())
          .then(res => console.log(res))
          .catch(err => console.error(err));
      }
    }

    function deleteFile(data) {
      // Handle the Delete action
      const instance = $.jstree.reference(data.reference);
      const selectedNode = instance.get_node(data.reference);


      if (selectedNode.children.length > 0) {
        // If the node has children, prompt the user to confirm deletion
        const confirmDelete = confirm("This node has children. Deleting it will also delete its children. Are you sure you want to delete?");

        if (confirmDelete) {
          instance.delete_node(selectedNode);
          moveFileToTrash(selectedNode);
        }
      } else {
        // If the node has no children, simply delete it
        instance.delete_node(selectedNode);
        moveFileToTrash(selectedNode);

      }
    }

    function moveFileToTrash(node) {
      if(node.data.mimeType.includes('application/vnd.google-apps.'))
      {
        gapi.client.drive.files.update({
          fileId: node.id,
          trashed: true
        }).then(function(response) {
          console.log('File moved to trash: ', response);
        }, function(error) {
          console.error('Error moving file to trash: ', error);
        });
      }
    }


    function CreateNewFolder(data,name)
    {
          // Handle the Add Document action
        const instance = $.jstree.reference(data.reference);
        const selectedNode = instance.get_node(data.reference);
        // Create the new child node with the document details
        const newNodeId = timeuuid();
        const newNodeText = name;

        const newNode = {
          id: newNodeId,
          text: newNodeText,
          data:{
            locked:false,
            mimeType: "application/folder",
          }
        };

        instance.create_node(selectedNode, newNode, 'last');
        // Select the newly created node
        instance.select_node(newNode);
        instance.open_node(selectedNode);
    }

    function CreateNewLink(data,name,url)
    {
          // Handle the Add Document action
        const instance = $.jstree.reference(data.reference);
        const selectedNode = instance.get_node(data.reference);
        // Create the new child node with the document details
        const newNodeId = timeuuid();
        const newNodeText = name;

        const newNode = {
          id: newNodeId,
          text: newNodeText,
          data:{
            locked:false,
            mimeType: "application/link",
            url:url
          }
        };

        instance.create_node(selectedNode, newNode, 'last');
        // Select the newly created node
        instance.select_node(newNode);
        instance.open_node(selectedNode);
    }

    function CreateNewFile(data,mimeType,name)
    {
      // Handle the Add Document action
    const instance = $.jstree.reference(data.reference);
    const selectedNode = instance.get_node(data.reference);

    // Create a new Google Document using the Drive API
    const createDocument = async () => {

      const metadata = {
        name: name,
        mimeType: mimeType,
        parents: [WorkspacesJSON["ActiveWorkspaceID"]],
      };

      accessToken = gapi.auth.getToken().access_token;

      try {
        const response = await fetch('https://www.googleapis.com/drive/v3/files', {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${accessToken}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(metadata),
        });

        const data = await response.json();
        console.log('New document created:', data);

        // Create the new child node with the document details
        const newNodeId = data.id;
        const newNodeText = data.name;

        const newNode = {
          id: newNodeId,
          text: newNodeText,
          data:{
            locked:false,
            mimeType: mimeType,
          }
        };

        instance.create_node(selectedNode, newNode, 'last');
        // Select the newly created node
        instance.select_node(newNode);
        instance.open_node(selectedNode);
      } catch (error) {
        console.error('Error creating document:', error);
      }
    };
      createDocument();
    }

    async function updateGoogleDriveFileName(fileId, newName) {
      const accessToken = gapi.auth.getToken().access_token; // Replace with your actual access token

      const metadata = {
        name: newName
      };

      try {
        const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
          method: 'PATCH',
          headers: {
            Authorization: `Bearer ${accessToken}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(metadata),
        });

        if (!response.ok) {
          throw new Error('Failed to rename file.');
        }
      } catch (error) {
        throw new Error(error.message);
      }
    }



    
    async function embedFile(fileId, mimeType,url="") {
      let embedUrl;
      if (mimeType === 'application/vnd.google-apps.document') {
        embedUrl = `https://docs.google.com/document/d/${fileId}/edit?usp=sharing&rm=demo`;
      } else if (mimeType === 'application/vnd.google-apps.spreadsheet') {
        embedUrl = `https://docs.google.com/spreadsheets/d/${fileId}/edit?usp=sharing&rm=demo`;
      } else if (mimeType === 'application/vnd.google-apps.presentation') {
        embedUrl = `https://docs.google.com/presentation/d/${fileId}/edit?usp=sharing&rm=demo`;
      }
      else if (mimeType === 'application/link') {
        window.open(url, '_blank');
        return;
      }
      else if (mimeType === 'application/folder') {
        return;
      }
       else {
        // Unsupported file type
        return;
      }

      const iframe = document.getElementById('FileEmbed');
      iframe.src = embedUrl;
    }


    function OpenDocInNewTab()
    {
      const iframe = document.getElementById('FileEmbed');
      let url = iframe.src;
      let newurl= url.replace('&rm=demo','');
      window.open(newurl, '_blank');
    }

    function fetchConfigJson() {
      gapi.client.drive.files
        .list({
          spaces: 'appDataFolder',
          fields: 'files(name,id)',
        })
        .then((response) => {
          const files = response.result.files;
          console.log(files);
          const configFile = files.find((file) => file.name === 'WorkspaceData.json');
          if (configFile) {
            gapi.client.drive.files
              .get({
                fileId: configFile.id,
                alt: 'media',
              })
              .then((response) => {
                console.log(response.body);
                const jsonData = JSON.parse(response.body);
                WorkspacesJSON = jsonData; 
                fillWorkspacesList();
              })
              .catch((error) => {
                console.error('Error retrieving WorkspaceData.json:', error);
              });
          } else {
            console.error('WorkspaceData.json file not found.');
          }
        })
        .catch((error) => {
          console.error('Error retrieving file list:', error);
        });
    }

    function saveConfigJson() {
      const fileMetadata = {
        name: 'WorkspaceData.json',
        parents: ['appDataFolder']
      };
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(fileMetadata)], { type: 'application/json' }));
      form.append('file', new Blob([JSON.stringify(WorkspacesJSON)], { type: 'application/json' }));

      const token = gapi.auth.getToken().access_token;
      const headers = new Headers({ 'Authorization': 'Bearer ' + token });

      // Check if the file already exists
      gapi.client.drive.files
        .list({
          spaces: 'appDataFolder',
          fields: 'files(name,id)',
        })
        .then((response) => {
          const files = response.result.files;
          const configFile = files.find((file) => file.name === 'WorkspaceData.json');
          if (configFile) {
            const fileId = configFile.id;
            fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
              method: 'PATCH',
              headers: headers,
              body: JSON.stringify(WorkspacesJSON)
            })
              .then(res => res.json())
              .then(res => console.log(res))
              .catch(err => console.error(err));
          } else {
            // File does not exist, create using POST
            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
              method: 'POST',
              headers: headers,
              body: form
            })
              .then(res => res.json())
              .then(res => console.log(res))
              .catch(err => console.error(err));
          }
        })
        .catch(err => console.error(err));
    }



    function fillWorkspacesList() {
      const workspaceSelector = document.getElementById('WorkspaceSelector');

      // Clear existing options
      workspaceSelector.innerHTML = '';

      // Add the default option
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.disabled = true;
      defaultOption.selected = true;
      defaultOption.textContent = 'Select your Workspace';
      workspaceSelector.appendChild(defaultOption);

      // Add options for each workspace
      WorkspacesJSON.Workspaces.forEach((workspace) => {
        const option = document.createElement('option');
        option.value = workspace.id;
        if(workspace.id == WorkspacesJSON["ActiveWorkspaceID"])
        {
            option.selected = true;
        }
        option.textContent = workspace.name;
        workspaceSelector.appendChild(option);
      });

      UpdateFileHierarchyToWorkspace(WorkspacesJSON["ActiveWorkspaceID"]); 
    }

    // Function to handle workspace selection change
    function handleWorkspaceChange() {
      const workspaceSelector = document.getElementById('WorkspaceSelector');
      const selectedWorkspaceId = workspaceSelector.value;

      // Find the selected workspace in the WorkspacesJSON.Workspaces array
      const selectedWorkspace = WorkspacesJSON.Workspaces.find(
        (workspace) => workspace.id === selectedWorkspaceId
      );

      if (selectedWorkspace) {
        // Update ActiveWorkspaceID and ActiveWorkspaceName
        WorkspacesJSON.ActiveWorkspaceID = selectedWorkspace.id;
        WorkspacesJSON.ActiveWorkspaceName = selectedWorkspace.name;


        // Perform any additional actions with the selected workspace
        UpdateFileHierarchyToWorkspace(selectedWorkspaceId);


        // Save the updated config
        saveConfigJson();
      }
    }




      function setCookie(cname, cvalue, exdays) {
        const d = new Date();
        d.setTime(d.getTime() + (exdays*24*60*60*1000));
        let expires = "expires="+ d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
      }

      function getCookie(cname) {
        let name = cname + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(';');
        for(let i = 0; i <ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) == ' ') {
            c = c.substring(1);
          }
          if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
          }
        }
        return "";
      }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
  
  </body>
</html>
